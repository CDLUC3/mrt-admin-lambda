# This file is not yet implemented
# 
# TODOs:
# [x] Modify all actions to repsond to the same method signature .perform_action()
# [ ] Determine handing needed for XML return for profile actions
# [x] Move param handing from the if/elsif/else block into action classes
# [x] Add generic logic to respond to .prod_support()
# [ ] Create the ability to lock sensitive operations or further restrict to special cognito groups
# [ ] Add descriptions
# [ ] Create automated testing where possible
# [ ] Add testing notes


# Properties
#   class - class to create
#   params - parameters to pass to the constructor
#   implentented: [true | false] default: true
#   prod_support: [true | false] default: true
#     new actions are kept false until they have been thoroughly tested in stage
#   category: 
#     Audit | Cognito | Delete object | Dev Ops | Ingest Admin Profiles | Ingest Batches and Folders |
#     Ingest Profiles | Inventory and Manifest | LDAP | Queue Management | Replication |
#     Storage Manifest | Storage Node Configuration | Storage Scan | Storage Scan Review
#   sensitivity: [readonly | reversible change | irreversible change | sensitive]
#   description: |
#     markdown description of the purpose of the action
#   testing: [automated | contextually automatable | automatable | manual]
#   testing_instructions: url to internal documentation describing how to perform a test
#   format: [text|json|xml], default: json
#   test_params: key/value pairs needed for testing

profiles:
  class: IngestProfileAction
  category: Ingest Profiles
  sensitivity: readonly
  testing: automated
  description: |
    List all *ingest profiles* known to the ingest server.
    An ingest profile describes characteristics associated with a collection's configuration, such as its context mnemonic, description and primary storage node. 
    These profiles are managed in a github repository and are deployed to the server.
collection-locks:
  class: IngestCollectionLocksAction
  category: Ingest Profiles
  sensitivity: readonly
  testing: automated
  description: |
    List all collections.  Show which ones are frozen/thawed.  Collections generally exist in a thawed state.

    This report allows the admin to freeze/thaw ingest processing for a collection.
    
    Once ingest processing for a collection has been thawed, any items that have accumulated into the Held queue for the collection must be released.  

    Items can be individually released from the [queue page](/web/collIndex.html?path=queues) or they can be released as a set from this page.
adminprofiles:
  class: AdminProfileAction
  category: Ingest Admin Profiles
  sensitivity: readonly
  testing: automated
  description: |
    List all *admin profiles* (collection, owner, SLA) known to the ingest server.
    Admin profiles define the hierarchy in which collections are managed.
    Every collection must sit beneath a campus-specific SLA and a library or unit-specific owner profile. 
    Admin profiles also provide a basis on which to roll up annual storage recharge calculations.
    These profiles are managed in a github repository and are deployed to the server.
state:
  class: IngestStateAction
  category: Queue Management
  sensitivity: readonly
  testing: automated
  description: |
    Display the state of the ingest service.
queues:
  class: IngestQueueAction
  category: Queue Management
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display the contents of the *ingest queue*. Items in this queue are slated to be processed by the Ingest service.
    From this screen, items can be requeued.
inv-queues:
  class: InventoryQueueAction
  category: Queue Management
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display the contents of the *inventory queue*. Items in this queue are slated to be processed by the Ingest service.
    From this screen, items can be requeued.
acc-queues:
  class: AccessQueueAction
  category: Queue Management
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display the contents of the *access queue*.
    From this screen, items can be requeued.
    Items in this queue are slated to be processed by the Store Access service. 
    More specifically, each queue item pertains to an end-user request to download an entire digital object. 
    Requests are routed to Access worker hosts based on object size (large or small).
batchFolders:
  class: IngestBatchFoldersAction
  category: Ingest Batches and Folders
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display details about the recently created ingest *batch folders*.
    In rare instances, an ingest is initiated but fails during the queueing step.  
    This view provides an opportunity to identify content that could not be successfully queued.
batch:
  class: IngestBatchAction
  category: Ingest Batches and Folders
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display details about an *ingest batch*.  A *batch* may contain one or more *jobs*.
job:
  class: IngestJobMetadataAction
  category: Ingest Batches and Folders
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display details about a specific *job* within an ingest batch.
manifest:
  class: IngestJobManifestAction
  category: Ingest Batches and Folders
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display the manifest defining the content to ingest in a specific *ingest job*.
files:
  class: IngestJobFilesAction
  category: Ingest Batches and Folders
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display the files remaining on the filesystem for an *ingest job*.
    After a successful submission:
    - producer files will be removed
    - system files will be retained
sword:
  class: IngestSwordJobsAction
  category: Ingest Batches and Folders
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display the most recent ingest jobs initiated from Dryad via the Sword service.
    After the page is displayed, a separate search is run to display the ARK and DOI associated with each job.
ldap/users:
  class: LDAPActionUsers
  category: LDAP
  sensitivity: readonly
  testing: automated
  description: | 
    Display the list of Merritt users defined in the Merritt LDAP database.
ldap/user:
  class: LDAPActionUserDetailed
  category: LDAP
  sensitivity: readonly
  testing: automated
  description: | 
    Display the details for a specific Merritt user defined in the Merritt LDAP database.
    The report conveys the permissions granted to the user on a collection basis.
ldap/roles:
  class: LDAPActionRoles
  category: LDAP
  sensitivity: readonly
  testing: automated
  description: | 
    Display the set of permission groups (roles) defined in the Merritt LDAP database.
ldap/role:
  class: LDAPAction
  category: LDAP
  sensitivity: readonly
  testing: automated
  description: | 
    Display information about a specific role defined in the Merritt LDAP database.
    *This report does not seem to be linked in the application**.
ldap/colls:
  class: LDAPActionColls
  category: LDAP
  sensitivity: readonly
  testing: automated
  description: | 
    Display the Merritt collections as defined in the  Merritt LDAP database.
    Oddly, the Merritt UI uses the Collection name defined in LDAP as the definitive display name for the collection.
ldap/coll:
  class: LDAPActionCollDetailed
  category: LDAP
  sensitivity: readonly
  testing: automated
  test_params:
    coll: merritt_demo
  description: | 
    List user details for a Merritt collection as defined in the  Merritt LDAP database, including user roles.
ldap/collmap:
  class: LDAPActionCollmap
  category: LDAP
  sensitivity: readonly
  testing: automated
  description: | 
    Generate a report that maps entities in the Merritt LDAP database to entries in the Merritt inventory database.
    For any items that do not match, an error will be reported in the report.  This indicates that maintenance needs to be performed on the LDAP entries for Merritt.
ldap/collark:
  class: LDAPActionCollArk
  category: LDAP
  sensitivity: readonly
  testing: automated
  description: |
    This report maps a *collection ark* (from the inventory database) to the set of LDAP permissions defined for that collection.
instances:
  class: TagAction
  category: Dev Ops
  sensitivity: readonly
  testing: automated
  description: |
    Generate a report describing the EC2 servers used by Merritt domain.  Server details are discovered by querying EC2 tags.
ssm-describe:
  class: SsmDescribeAction
  category: Dev Ops
  sensitivity: readonly
  testing: automated
  description: |
    Generate a report describing the SSM variables used by a Merritt domain.
    These variables are compared against a [registry of expected SSM variables](https://github.com/CDLUC3/mrt-admin-lambda/blob/main/src-colladmin/config/ssm.registry.yml).
storage-get-manifest:
  class: StorageAction
  category: Storage Manifest
  sensitivity: readonly
  testing: automated
  format: xml
  test_params:
    ark: ark:/99999/fk4dv31c0b
    nodenum: 9502
  description: |
    Download the XML *storage manifest* representation of a object on a specific storage node.  This request will be forwarded to the storage service.
storage-get-augmented-manifest:
  implemented: false
  category: Storage Manifest
  sensitivity: readonly
  testing: automatable
  description: |
    #### Future Feature
    Download a programmatically repaired manifest generated by the storage/replication service.
    This feature is anticipated to be utilized to resolve specific problems that occur infrequently.
storage-get-ingest-checkm:
  class: StorageAction
  category: Storage Manifest
  sensitivity: readonly
  testing: automated
  format: text
  test_params:
    ark: ark:/99999/fk4dv31c0b
    nodenum: 9502
  description: |
    Download an *ingest manifest checkm* representation of an object on a specific storage node.  
    This file could be utilized to re-ingest an object under a new ark.
cognito-users:
  class: CognitoAction
  category: Cognito
  sensitivity: readonly
  testing: automated
  description: |
    Display the list of users who have authenticated to the Merritt Admin *Cognito User Pool*.
    Users are not created explicitly in the admin tool. A user is created by (1)performing an SSO login or (2)registering as a non-SAML user.  
    This screen contains buttons that could trigger the addition/removal of specific users from a *Cognito User Group*.

    Note: While the tool supports non-SAML users, in practice, we have not authorized any non-SAML users.  This is intended for partners such as Dryad staff.
replication-state:
  class: ReplicationAction
  category: Dev Ops
  sensitivity: readonly
  testing: automated
  format: xml
  description: |
    Display the *storage scan status* of the replication service.
    This function determines whether or not to enable the *Stop Storage Scan* and *Enable Storage Scan* buttons.
storage-review-csv:
  class: ReplicationAction
  category: Storage Scan
  sensitivity: readonly
  testing: manual
  description: |
    Download a CSV file for all scan results from a specific storage node that have been marked with a *Review* status.
    This CSV can be edited in Excel in order to apply bulk status/note changes to the scan results.
ingest-locks:
  class: IngestLockAction
  category: Lock Management
  sensitivity: readonly
  testing: contextually automated
  description: |
    Display the ingest storage locks existing for object arks.

# Operations that change system state - Reversible

submissions/pause:
  class: PostToIngestAction
  params: ["admin/submissions/freeze"]
  category: Queue Management
  sensitivity: reversible change
  testing: automatable
  description: |
    Pause all ingest processing.  Return the effective state of the ingest queues.
    This is typically done before a patching cycle or a software release that impacts ingest or storage.
submissions/unpause:
  class: PostToIngestAction
  params: ["admin/submissions/thaw"]
  category: Queue Management
  sensitivity: reversible change
  testing: automatable
  description: |
    Unpause ingest processing.  Return the effective state of the ingest queues.
toggle_harvest:
  class: AdminProfileAction
  category: Ingest Admin Profiles
  sensitivity: reversible change
  testing: automatable
  description: |
    Toggle the *harvest* flag for a collection.
    The harvest flag determines whether or not a collection can be crawled from the OAI service.    
unlock-coll:
  class: QueueAction
  params: ["admin/submission/thaw/coll"]
  category: Queue Management
  sensitivity: reversible change
  testing: automatable
  description: |
    Unlock ingest for a collection.
lock-coll:
  class: QueueAction
  params: ["admin/submission/freeze/coll"]
  category: Queue Management
  sensitivity: reversible change
  testing: automatable
  description: |
    Lock ingest for a collection.
release-coll-queue-items:
  class: QueueAction
  params: ["admin/release-items/coll"]
  category: Queue Management
  sensitivity: reversible change
  testing: automatable
  description: |
    Release any held items for a collection.
storage-force-audit-for-object:
  class: StorageAction
  category: Audit
  sensitivity: reversible change
  testing: automatable
  description: |
    Trigger audit processing for all files in an object on a specific node.
storage-rerun-audit-for-object:
  class: StorageAction
  category: Audit
  sensitivity: reversible change
  testing: automatable
  description: |
    Trigger audit processing for all *unverified* files in an object on a specific node.
    This action is occasionally needed when the audit server is halted or experienced a networking issue on a previous audit.
storage-force-replic-for-object:
  class: StorageAction
  category: Replication
  sensitivity: reversible change
  testing: automatable
  description: |
    Re-trigger replication for an existing object.  The replication service will resolve incomplete replications for files in the object.
    This action is occasionally needed when the replic server is halted or experienced a networking issue on a previous replication.
storage-clear-audit-batch:
  class: StorageAction
  category: Audit
  sensitivity: reversible change
  testing: automatable
  description: |
    The audit service processes a block of objects at one time.  All database updates are written back to the database in a batch.
    If the audit service is shut down while processing a batch, some batches may appear to still be actively processing.
    This function clears all audit batches older than a specified amount of time.
storage-retry-audit-status:
  class: StorageAction
  category: Audit
  sensitivity: reversible change
  testing: automatable
  description: |
    Trigger an audit retry for all audit records with a specific status.
storage-cancel-all-scans:
  class: ReplicationAction
  category: Storage Scan
  sensitivity: reversible change
  testing: automatable
  description: |
    Halt all storage scan processing by the replciation service.  This will give priority to content replication.
storage-allow-all-scans:
  class: ReplicationAction
  category: Storage Scan
  sensitivity: reversible change
  testing: automatable
  description: |
    Re-enable storage scan processing by the replciation service.  This can be run after halting/canceling all scans.
storage-cancel-scan-node:
  class: ReplicationAction
  category: Storage Scan
  sensitivity: reversible change
  testing: automatable
  description: |
    Cancel storage scan processing *on a specific storage node* by the replication service.  
storage-resume-scan-node:
  class: ReplicationAction
  category: Storage Scan
  sensitivity: reversible change
  testing: automatable
  description: |
    Resume storage scan processing *on a specific storage node* by the replication service.  
storage-clear-scan-entries:
  class: StorageAction
  category: Storage Scan Review
  sensitivity: reversible change
  testing: manual
  description: |
    Clear storage scan entries for a specific ark.
    This function is intended to be run after *rebuilding an inventory record* via the admin tool.  
storage-scan-node:
  class: ReplicationAction
  category: Storage Scan
  sensitivity: reversible change
  testing: automatable
  description: |
    Initiate storage scan processing *on a specific storage node* by the replication service.  
    
    In general, the storage scan process uses the S3 API to iterate over items found on a storage node.
    For SDSC storage, the iterator api call does not function properly.  
    Instead, an inventory dump must be manually requested from SDSC and uploaded to S3 for comparison processing.
storage-delete-node-key:
  class: ReplicationAction
  category: Storage Scan Review
  sensitivity: reversible change
  testing: manual
  description: |
    Mark a single scan result with a *DELETE* status.  
storage-delete-node-page:
  class: ReplicationAction
  category: Storage Scan Review
  sensitivity: reversible change
  testing: manual
  description: |
    Mark a page of scan results with a *DELETE* status.  
storage-hold-node-key:
  class: ReplicationAction
  category: Storage Scan Review
  sensitivity: reversible change
  testing: manual
  description: |
    Mark a single scan result with a *HOLD* status.  
storage-hold-node-page:
  class: ReplicationAction
  category: Storage Scan Review
  sensitivity: reversible change
  testing: manual
  description: |
    Mark a page of scan results with a *HOLD* status.  
storage-review-node-key:
  class: ReplicationAction
  category: Storage Scan Review
  sensitivity: reversible change
  testing: manual
  description: |
    Mark a single scan result with a *REVIEW* status.  
storage-review-node-page:
  class: ReplicationAction
  category: Storage Scan Review
  sensitivity: reversible change
  testing: manual
  description: |
    Mark a page of scan results with a *REVIEW* status.  

# Operations that change system state - Not reversible

submit-profile:
  class: SubmitProfileAction
  params: ["poster/update"]
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Submit a dummy object using a newly created admin profile.
    This will trigger the creation of an object in the Merritt inventory database.
set_mnemonic:
  class: AdminProfileAction
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Set the *mnemonic* field for a collection to match the value defined in the collection admin profile.
    Once set, this value cannot be reset.
    This option must be manually run due to a legacy limitation of the collection creation process for Merritt.
set_coll_name:
  class: AdminProfileAction
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Set the *description* field for a collection to match the value defined in the collection admin profile.
    To apply future changes to this field, you must update the collection admin profile.
set_sla_name:
  class: AdminProfileAction
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Set the *description* field for an SLA to match the value defined in the SLA admin profile.
    To apply future changes to this field, you must update the SLA admin profile.
set_own_name:
  class: AdminProfileAction
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Set the *description* field for an Owner to match the value defined in the Owner admin profile.
    To apply future changes to this field, you must update the Owner admin profile.
create_owner_record:
  class: AdminProfileAction
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Generate an owner record in the Merritt inventory database based on the submission of a dummy object using the Owner Admin profile.
create_coll_record:
  class: AdminProfileAction
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Generate an SLA record in the Merritt inventory database based on the submission of a dummy object using the SLA Admin profile.
createProfile/profile:
  class: PostToIngestMultipartAction
  params: ["admin/profile/profile"]
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Send a request to the ingest service to generate a new *Ingest Profile*.
    A new ARK will be minted as needed.
createProfile/collection:
  class: PostToIngestMultipartAction
  params: ["admin/profile/collection"]
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Send a request to the ingest service to generate a new *Collection Admin Profile*.
    A new ARK will be minted as needed.
createProfile/owner:
  class: PostToIngestMultipartAction
  params: ["admin/profile/owner"]
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Send a request to the ingest service to generate a new *Owner Admin Profile*.
    A new ARK will be minted as needed.
createProfile/sla:
  class: PostToIngestMultipartAction
  params: ["admin/profile/sla"]
  category: Ingest Admin Profiles
  sensitivity: irreversible change
  testing: manual
  description: |
    Send a request to the ingest service to generate a new *SLA Admin Profile*.
    A new ARK will be minted as needed.
queue-delete:
  class: QueueAction
  params: ["admin/deleteq"]
  category: Queue Management
  sensitivity: irreversible change
  testing: manual
  description: |
    Remove an item from a Zookeeper queue.
requeue:
  class: QueueAction
  params: ["admin/requeue"]
  category: Queue Management
  sensitivity: irreversible change
  testing: manual
  description: |
    Re-queue an item from a Zookeeper queue.
hold-queue-item:
  class: QueueAction
  params: ["admin/hold"]
  category: Queue Management
  sensitivity: irreversible change
  testing: manual
  description: |
    Move a pending item from in Zookeeper queue to a Held status.
release-queue-item:
  class: QueueAction
  params: ["admin/release"]
  category: Queue Management
  sensitivity: irreversible change
  testing: manual
  description: |
    Release a held item from in Zookeeper queue to a Pending status.
apply-review-changes:
  class: ReplicationAction
  category: Storage Scan Review
  sensitivity: irreversible change
  testing: manual
  description: |
    Apply bulk changes to storage scan results by uploading a CSV containing a set of desired changes.

# Sensitive Operations

cognito-remove-user-from-group:
  class: CognitoAction
  category: Cognito
  sensitivity: sensitive
  testing: automatable
  description: |
    Remove a *Cognito User* from a specific *Cognito User Group*.
cognito-add-user-to-group:
  class: CognitoAction
  category: Cognito
  sensitivity: sensitive
  testing: automatable
  description: |
    Add a *Cognito User* to a specific *Cognito User Group*.
storage-rebuild-inventory:
  class: StorageAction
  category: Inventory and Manifest
  sensitivity: sensitive
  testing: automatable
  description: |
    Retrieve a storage manifest from the storage service.  
    Send that manifest to the Inventory service in order to re-build the inventory record from the storage manifest.
storage-update-manifest:
  implemented: false
  category: Inventory and Manifest
  sensitivity: sensitive
  testing: manual
  description: |
    #### Future Feature: upload a repaired storage manifest to override an existing one
storage-add-node-for-collection:
  class: StorageAction
  category: Storage Node Configuration
  sensitivity: sensitive
  testing: manual
  description: |
    Add a secondary storage node to the configuration for a collection.
storage-del-node-for-collection:
  prod_support: false
  class: StorageAction
  category: Storage Node Configuration
  sensitivity: sensitive
  testing: manual
  description: |
    Remove a storage node from a collection configuration.
    All objects in the collection will need to be cleared from the storage node.

    #### Not yet implemented in prod
replic-delete-coll-batch-from-node:
  prod_support: false
  class: ReplicationAction
  category: Storage Node Configuration
  sensitivity: sensitive
  testing: manual
  description: |
    Delete a batch of objects from the collection from this node.  This may need to run iteratively.

    #### Not yet implemented in prod
storage-del-object-from-node:
  implemented: false
  category: Delete object
  sensitivity: sensitive
  testing: manual
  description: |
    #### Future feature - Probably not needed
    [Feature Design](https://cdluc3.github.io/mrt-doc/diagrams/store-admin-del-node-obj)
storage-change-primary-for-collection:
  implemented: false
  category: Storage Node Configuration
  sensitivity: sensitive
  testing: manual
  description: |
    #### Future feature
    [Feature Design](https://cdluc3.github.io/mrt-doc/diagrams/store-admin-change-primary-node)
storage-reroute-ui-for-collection:
  implemented: false
  class: ReplicationAction
  sensitivity: sensitive
  testing: manual
  description: |
    #### Future feature - Probably not in scope for the project
    [Feature Design](https://cdluc3.github.io/mrt-doc/diagrams/store-admin-reroute-uistorage-perform-delete-node-key)
storage-perform-delete-node-batch:
  # prod_support: false
  class: ReplicationAction
  category: Storage Scan Review
  sensitivity: sensitive
  testing: manual
  description: |
    #### Not yet enabled in prod 
    Process all scan results marked with a *DELETE* status.
storage-delete-obj:
  implemented: false
  category: Storage Scan Review
  sensitivity: sensitive
  testing: manual
  description: |
    #### Future feature
    Trigger the deletion of a Merritt Object.  Save a tombstone record.
    [Feature Design](https://cdluc3.github.io/mrt-doc/diagrams/store-admin-del-obj)
